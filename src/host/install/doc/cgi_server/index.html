<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>CGI Server: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CGI Server
   &#160;<span id="projectnumber">version 7.10.87620</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">CGI Server Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#introduction">Introduction</a></li>
<li class="level1"><a href="#references">References</a></li>
<li class="level1"><a href="#cmd_format">Command format</a><ul><li class="level2"><a href="#server_replies">Server replies</a></li>
<li class="level2"><a href="#querying">Querying the server</a></li>
<li class="level2"><a href="#setting_params">Setting parameters</a></li>
</ul>
</li>
<li class="level1"><a href="#streaming">Streaming</a><ul><li class="level2"><a href="#video">Video</a></li>
<li class="level2"><a href="#motion_values">Motion values</a></li>
</ul>
</li>
<li class="level1"><a href="#network">Network</a><ul><li class="level2"><a href="#network_parameters">Network parameters</a></li>
<li class="level2"><a href="#recovery">Discovery and Recovery</a></li>
</ul>
</li>
<li class="level1"><a href="#commands">CGI Commands</a><ul><li class="level2"><a href="#login">Login</a></li>
<li class="level2"><a href="#logout">Logout</a></li>
<li class="level2"><a href="#user">User</a></li>
<li class="level2"><a href="#date">Date</a></li>
<li class="level2"><a href="#firmware">Firmware</a></li>
<li class="level2"><a href="#reboot">Reboot</a></li>
<li class="level2"><a href="#reset">Reset</a></li>
<li class="level2"><a href="#status">Status</a></li>
<li class="level2"><a href="#device_info">Device_info</a></li>
<li class="level2"><a href="#stream">Stream</a></li>
<li class="level2"><a href="#image">Image</a></li>
<li class="level2"><a href="#snapshot">Snapshot</a></li>
<li class="level2"><a href="#roi">Regions of Interest</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Copyright 2013 by Stretch, Inc., All Rights Reserved</p>
<h1><a class="anchor" id="introduction"></a>
Introduction</h1>
<p>The purpose of the CGI server is to provide capability to set and retrieve limited set of camera parameters and to configure RTSP server to stream video. The RTSP server capabilities are described briefly here for completeness.</p>
<h1><a class="anchor" id="references"></a>
References</h1>
<p>The camera adheres to the following standards:</p>
<ul>
<li><a href="http://tools.ietf.org/html/rfc2616">RFC 2616</a>: Hypertext Transfer Protocol HTTP/1.1</li>
<li><a href="http://tools.ietf.org/html/rfc3986">RFC 3986</a>: Uniform Resource Identifier (URI): Generic Syntax</li>
<li><a href="http://tools.ietf.org/html/rfc2326">RFC 2326</a>: Real Time Streaming Protocol (RTSP)</li>
<li><a href="http://tools.ietf.org/html/rfc3550">RFC 3550</a>: RTP: A Transport Protocol for Real-Time Applications</li>
<li><a href="http://tools.ietf.org/html/rfc3984">RFC 3984</a>: RTP Payload Format for H.264 Video</li>
<li><a href="http://tools.ietf.org/html/rfc2435">RFC 2435</a>: RTP Payload Format for JPEG-compressed Video</li>
<li><a href="http://tools.ietf.org/html/rfc3640">RFC 3640</a>: RTP Payload Format for Transport of MPEG-4 Elementary Stream</li>
<li><a href="http://tools.ietf.org/html/rfc826">RFC 826</a>: An Ethernet Address Resolution Protocol</li>
</ul>
<h1><a class="anchor" id="cmd_format"></a>
Command format</h1>
<p>HTTP requests directed to CGI server include <em>cgi-bin</em> string after the server name or IP address, followed by the name of the command and any parameters. The general format of the CGI request is </p>
<pre class="fragment">http://&lt;server_name&gt;/cgi-bin/&lt;command_name&gt;?&lt;argument&gt;[=&lt;value&gt;[&amp;&lt;argument&gt;[=&lt;value&gt;...]]]
</pre><ul>
<li><em>server_name</em> is a name or IP address of the camera</li>
<li><em>cgi-bin</em> is a fixed string, which directs the request to CGI server</li>
<li><em>command_name</em> is the name of the command</li>
<li><em>argument</em> is the argument name</li>
<li><em>value</em> is the argument value</li>
</ul>
<p>The URL must be written conformant to the standard URL encoding described in RFC 3986. The CGI server issues a reply to each command. In the remaining part of this document, the <code><a href="http://">http://</a>&lt;server_name&gt;/cgi-bin prefix</code> will be omitted when specifying command URI for brevity. Unless it is explicitly stated in this specification, all requests use HTTP GET command.</p>
<p>Each argument may be specified only once. Arguments may be supplied in any order.</p>
<p>Only characters from the following character set may be used: a-zA-Z0-9:.-+/?=. The forward slash '/' and question mark '?' characters may only be used as URL part separators. The equal sign '=' character may only be used to separate argument name from argument value.</p>
<dl class="section note"><dt>Note</dt><dd>The server does not implement full URL character decoding as specified in RFC 3986 and in particular "percent encoding" is not supported.</dd></dl>
<h2><a class="anchor" id="server_replies"></a>
Server replies</h2>
<p>The server replies to each command. The default replies are as follows:</p>
<h3>Success</h3>
<pre class="fragment">HTTP Code:      200 OK 
Content-Type:   text/plain 
Body:
OK
</pre><p> The reply body is command dependent, but if the reply would otherwise be empty, then OK string is sent.</p>
<h3>Failure</h3>
<pre class="fragment">HTTP Code:       200 OK
Content-Type:   text/plain 
Body:
Error: &lt;error description&gt;
</pre><dl class="section note"><dt>Note</dt><dd>Even in case of failure, HTTP code 200 is returned. The client must parse message body to determine if the command was successful or not.</dd></dl>
<p>When a server reply to a command is different then described above, it is explicitly listed in this document. When a command fails, it does not modify the state of the camera. In other words, checking for error is done before any modifications to the camera state are done.</p>
<h2><a class="anchor" id="querying"></a>
Querying the server</h2>
<p>Many (but not all) commands have arguments <em>action=get</em> and <em>action=set</em>. This is indicated by listing specifying two URIs for the command. In those cases, the set argument value is used to set parameters, while the get argument value is used to return values of all parameters associated with the command. Unless explicitly specified otherwise, the format of the body of the reply to <em>action=get</em> argument is: </p>
<pre class="fragment">&lt;parameter_name&gt;=&lt;parameter_value&gt;
</pre><p>The order of name/value list is undefined. If used, <em>action=get</em> must the only argument.</p>
<h2><a class="anchor" id="setting_params"></a>
Setting parameters</h2>
<p>When parameters are set using the set argument, only those parameters that are given to the command are modified. For example, when setting the date, if the command is <code>/date?action=set&amp;day=20</code>, only the current day is changed while all other parameters (month, year, etc ...) remain unchanged.</p>
<h1><a class="anchor" id="streaming"></a>
Streaming</h1>
<h2><a class="anchor" id="video"></a>
Video</h2>
<p>To access the real time video stream produced by the camera, a client must connect to the server using RTSP protocol: </p>
<pre class="fragment">rtsp://&lt;server_name&gt;/video/&lt;id&gt;
</pre><p>Where <em>server_name</em> is a name or IP address of the camera and <em>id</em> is an integer in range of 0 to 3 inclusive. Furthermore, the stream must be correctly configured and enabled using <em>cgi-bin</em> commands and described in this document. If a stream is disabled, the camera will reply to initial RTSP commands (such as OPTIONS), but will return RTSP error when a client attempts to issue DESCRIBE, SETUP or PLAY commands for such a stream. The server uses RTSP default port 554. The reference client for the RTSP-based streaming is VLC and the camera will stream video as long as the client followed the RFCs as implemented by VLC.</p>
<p>The camera is able to stream a stream to multiple clients simultaneously. The client must maintain a RTSP TCP session to the server. If the client terminates TCP session, the server stops streaming RTP stream to that client. A client may use RTSP GET_PARAMETER commands and the server replies to them, but the server does not use such commands as keep-alives.</p>
<h2><a class="anchor" id="motion_values"></a>
Motion values</h2>
<p>The camera includes motion detection logic. For each 128x128 block, motion is detected by computing the absolute difference between a set of block means and an IIR filtered version of the block means. In addition, an aggregate motion is computed as a sum of all motion values within the image. When enabled (<em>image?motion_rate</em> parameter), motion values are streamed as UDP packets to the address specified by motion_dest parameter. When <em>motion_rate</em> is 1, one UDP packet is sent per one video frame when enabled. The format of the UDP motion value packet is as follows: </p>
<pre class="fragment"> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       M       |   V           |             seq_num           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           timestamp                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    width      |  height       |aggregate mot. |  reserved     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| motion value  | motion value  | motion value  | motion value..|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre><p>The first two bytes contain fixed pattern, characters 'M' and 'V'. The seq_num field contains a sequence number, which is incremented by one for each UDP motion value packet sent. The initial value of the sequence number is undefined. The timestamp contains 32-bit timestamp of the frame for which these motion values are generated.</p>
<p>Motion values are represented as 8 bits per one 128x128 block in network byte order, scanning the image from left to right and from top to bottom. The width represents number of 128x128 blocks in horizontal direction (and therefore number of motion values per image line) and height represents number of blocks in the vertical direction. The aggregate motion is the maximum of all motion values for the whole image and is followed by individual motion values, starting from top left corner. Aggregate motion and motion values are each 8 bit unsigned integers.</p>
<p>Total length of the motion value UDP packet payload is 148 bytes and can be computed as follows:</p>
<ul>
<li>2 bytes for characters M and V</li>
<li>2 bytes for sequence number</li>
<li>4 bytes for timestamp</li>
<li>4 bytes for width, height, aggregate motion and reserved</li>
<li>15x9 = 135 bytes for motion value (1920x1080 resolution)</li>
<li>1 unused byte The rate at which motion values are generated is the maximum rate of all enabled streams. For example, by default, both stream 0 and stream 1 are enabled while other streams are disabled. Stream 1 operates by default at 25 frames per second and stream 1 at 15 frames per second. Thus, motion values will be generated at 25 frames per second. The <em>motion_rate</em> argument of image command controls the sending rate of motion vectors, not their generation. In the example above, and with motion_rate=1, motion frames will transmitted 25 times per second, while with motion_rate=5, at 5 frames per second. The side effect of these constraints is that at least one stream must be enabled for motion vectors to be generated, although it is not necessary that any streaming clients are connected.</li>
</ul>
<h1><a class="anchor" id="network"></a>
Network</h1>
<h2><a class="anchor" id="network_parameters"></a>
Network parameters</h2>
<p>Section <a class="el" href="index.html#device_info">Device_info</a> describes <em>device_info</em> command, which is used to manage system parameters, including network settings. This section describes those parameters in more details. Certain parameters of the device_info command (called front-end parameters) are only relevant and maintained by the CGI server, while others (called back-end parameters) affect the underlying operating system (Linux) and the network protocol. A user who would log into the device using ssh will be able to detect changes to back-end parameters using standard Linux commands, while front-end parameters are only available via CGI server command line. In addition, certain of the parameters are read-only, while others are read-write. Attempts to modify read-only parameters with <code>device_info?action=set</code> command will return an error.</p>
<ul>
<li><em>firmware</em> is a read-only front-end parameter.</li>
<li><em>hostname</em> is a read-write back-end parameter.</li>
<li><em>mac_address</em> is a read-write back end parameter.</li>
<li><em>serial_number</em> is a read-only back end parameter.</li>
<li><em>model</em> is read-write front-end parameter.</li>
<li><em>motion_dest</em> is a read-write front-end parameter</li>
</ul>
<p>Parameters <em>ip_address</em>, <em>subnet</em> and <em>gateway</em> are back-end parameters and their behavior depends on the <em>dhcp</em> settings (these four parameters are called network related parameters).</p>
<ul>
<li>If <em>dhcp</em> is true, then <em>ip_address</em>, <em>subnet</em> and <em>gateway</em> are read-only parameters. The DHCP client obtains these parameters from a DHCP server that must be present on the same network link and forwards them to the CGI server, which uses them in reply to <code>device_info?action=get</code> command.</li>
<li>If <em>dhcp</em> is false, then <em>ip_address</em>, <em>subnet</em> and <em>gateway</em> are read-write parameters. DHCP client is not used and the CGI server sets these parameters in the operating system settings (as static IP address). Since network settings are only applied during the boot, changes to network related device_info parameters require reboot. Specifically, device will reboot if:</li>
<li><em>dhcp</em> is changed</li>
<li><em>dhcp</em> is false and <em>ip_address</em>, <em>subnet</em> or <em>gateway</em> are changed</li>
</ul>
<p>The <em>dhcp</em> argument affects how the device acquires network settings, which happens during the boot time. In the context of this paragraph, network settings means ip address, subnet and gateway address. If <em>dhcp</em> is false, then the last used network settings will be used. For example, if <em>dhcp</em> is true and a command <code>device_info?dhcp=false</code> is issued, then network parameters acquired via DHCP will be applied as static values after reboot. Therefore, it is recommened to fully specify desired network parameters when changing <em>dhcp</em> from true to false, for example: </p>
<pre class="fragment">device_info?dhcp=false&amp;ip_address=192.168.6.44&amp;subnet=255.255.255.0&amp;gateway=192.168.1.254&amp;action=set
</pre><p>If dhcp is true then the camera attempts to obtain network parameters from a DHCP server. If the server is unavailable, then a fixed set of parameters will be used:</p>
<ul>
<li>ip_address=192.168.1.60</li>
<li>subnet=255.255.255.0</li>
<li>gateway=192.168.1.254</li>
</ul>
<h2><a class="anchor" id="recovery"></a>
Discovery and Recovery</h2>
<p>A standard <a href="http://www.avahi.org">Avahi</a> daemon runs on a camera and replies to network discovery requests. The daemon works independently of CGI Server. On most Linux distributions, the avahi-browse command may be used to discover the camera.</p>
<p>In addition, the CGI server implements a proprietary protocol to discover and recover cameras with incorrect network settings. Currently, that protocol is not enabled by default. To enable the protocol, you need to insert the following line into the lighttpd configuration file: </p>
<pre class="fragment">CGI_SERVER_BCAST    =&gt; "magic_bytes bcast_address port"
</pre><p>When enabled, the CGI server will listen for a broadcast IP packet on the specified <em>port</em>. The packet first line must be exactly <em>magic_bytes</em>. If this is the only line in the packet, the CGI server will execute <em>device_info?action=get</em> command and send the reply to a <em>bcast_address</em> and (<em>port</em> + 1). The reply packet consists of <em>magic_bytes</em>, followed by the command reply. Note that all cameras with network discovery enabled will reply to this packet.</p>
<p>If there are more then one line, then the second line must be the camera mac address (in 01:23:45:67:ab format) and the third line must be a command to execute. If the first line matches the <em>magic_bytes</em> and the second line matches mac address, then the CGI server will execute the command and send back the reply (preceeded by <em>magic_bytes</em> line) to <em>bcast_address</em> and <em>port</em> + 1. Note that only the camera with the specified mac_address will reply to this packet.</p>
<p>The line termination in IP packets used in this mechansim is the string _\r\n_. The fields in CGI_SERVER_BCAST are separated by one or more spaces. <em>bcast_address</em> and <em>port</em> are optional, if not provided, they default to 255.255.255.255 and 8000. The valid characters for <em>magic_bytes</em> are in 33-126 range.</p>
<dl class="section note"><dt>Note</dt><dd>The payload in each UDP packet used in this protocol always starts with <em>magic_bytes</em> followed by \r\n.</dd>
<dd>
Since this mechanism uses IP broadcast and UDP packets, packet delivery is not guaranteed by the network. For example, many routers are configured to block broadcast traffic.</dd></dl>
<h1><a class="anchor" id="commands"></a>
CGI Commands</h1>
<p>This section describes individual CGI commands.</p>
<h2><a class="anchor" id="login"></a>
Login</h2>
<pre class="fragment">/login?user=root&amp;password=&lt;password&gt;
</pre><table class="doxtable">
<tr>
<th>Argument </th><th>Type </th><th>Valid values </th><th>Description</th></tr>
<tr>
<td>user </td><td>string </td><td>root </td><td>User name </td></tr>
<tr>
<td>password </td><td>string </td><td>[a-zA-Z0-9_]{1,12} </td><td>Root password </td></tr>
</table>
<p>The command allows user login. The only supported user is root. Both arguments are mandatory. The initial default password is password. The password may be changed with user command. After a reboot, the server will reply with an error code to all commands until a login command with correct user and password is received.</p>
<h3>Example</h3>
<pre class="fragment">/login?user=root&amp;password=password
</pre><h2><a class="anchor" id="logout"></a>
Logout</h2>
<pre class="fragment">/logout?user=root
</pre><p>This command logouts user and the camera will reply with an error code to all further commands until a login with correct user and password is received.</p>
<h2><a class="anchor" id="user"></a>
User</h2>
<pre class="fragment">/user?action=set?user=root&amp;password=&lt;password&gt;
</pre><p>Valid characters for password are: [a-zA-Z0-9_]. Password must be minimum 1 character and maximum 12 characters long.</p>
<h2><a class="anchor" id="date"></a>
Date</h2>
<pre class="fragment">/date?action=set&amp;&lt;argument&gt;=&lt;value&gt;
/date?action=get
</pre><table class="doxtable">
<tr>
<th>Argument </th><th>Type </th><th>Valid values </th><th>Description </th></tr>
<tr>
<td>year </td><td>int </td><td>2010 ... 2100 </td><td>Current year </td></tr>
<tr>
<td>month </td><td>int </td><td>1 .. 12 </td><td>Current month </td></tr>
<tr>
<td>day </td><td>int </td><td>1 .. 31 </td><td>Current day </td></tr>
<tr>
<td>hour </td><td>int </td><td>0 .. 23 </td><td>Current hour (24 hour format) </td></tr>
<tr>
<td>minute </td><td>int </td><td>0 .. 59 </td><td>Current minute </td></tr>
<tr>
<td>second </td><td>int </td><td>0 .. 59 </td><td>Current second </td></tr>
<tr>
<td>timezone </td><td>string </td><td>See Note 1 </td><td>Timezone </td></tr>
<tr>
<td>dst </td><td>bool </td><td>true, false </td><td>Daylight Saving Time </td></tr>
</table>
<p>Timezone is specified by the following string: GMT+HH:MM or GMT-HH:MM (HH is hour in 0..12 range and MM is minute in 0..59). The timezone is interpreted as the time to add to UTC to obtain local time. For example, GMT-08:00 refers to PST (Pacific Standard Time).</p>
<p>DST (Daylight Saving Time), when enabled, causes the system to add one hour to the displayed time.</p>
<p>After a reboot, the camera updates the date and time, by attempting to contact a NTP server. If that is unsuccessful, a fixed date and time will be set up: 2010-01-01 00:00:00.</p>
<dl class="section note"><dt>Note</dt><dd>Changing the date in cgi_server also changes linux system date and vice-versa.</dd></dl>
<h3>Reply</h3>
<p>Reply to date does not follow the normal <code>&lt;parameter&gt;=&lt;value&gt;</code> format. Instead, the reply is as follows. </p>
<pre class="fragment">HTTP Code:      200 OK 
Content-Type:   text/plain 
Body:
month/day/year hour:minute:second timezone
</pre><p>When DST is enabled, the DST string follows timezone.</p>
<h3>Example</h3>
<pre class="fragment">GET /cgi-bin/date?action=set&amp;year=2012&amp;month=2
</pre><p>This command will update the year and the month. Note that that if when the command is executed, the current day is for example 31, the command will fail. </p>
<pre class="fragment">GET /cgi-bin/date?action=get

Reply
2/28/2013 23:15:11 GMT+08:00 DST
</pre><h2><a class="anchor" id="firmware"></a>
Firmware</h2>
<pre class="fragment">/firmware?file=&lt;name&gt;    (with POST method)
/firmware                (with GET method)
</pre><table class="doxtable">
<tr>
<th>Argument </th><th>Type </th><th>Valid values </th><th>Description </th></tr>
<tr>
<td>file </td><td>string </td><td>see below </td><td>name of the file to write to flash </td></tr>
</table>
<p>In the first form, this command writes the provided file to flash. The name argument must be one of:</p>
<ul>
<li>rootfs.img.gz when the provided file is a linux rootfs (written to /dev/mtd3)</li>
<li>uImage when the provided is file Linux kernel (written to /dev/mtd2)</li>
<li>u-boot.bin when the provided file is uboot (written to /dev/mtd1)</li>
<li>local.tar.gz when the provided file is tarred content of /usr/local (written to /mnt/local/local.tar.gz)</li>
<li>startup when the provided file is the camera startup file</li>
</ul>
<p>The file content is provided in the HTTP body according to the format given in RFC 1867, if HTTP POST method is used. In the second form (without argument), the command displays a input form, which allows to browse for the file to flash and send it to the server.</p>
<dl class="section note"><dt>Note</dt><dd>It is recommended that no clients are attached to the camera during firmware command execution, particularly for large files, such as rootfs.img.gz. The camera automatically suspends all streaming during the time files are written to flash and temporarily disables the watchdog during the execution of the firmware command, to minimize the risk of flash corruption due to reboot during writing of the files.</dd></dl>
<h3>Example</h3>
<pre class="fragment">POST /strech-cgi/firmware?file=rootfs.img.gz HTTP/1.0 
Content-Type: multipart/form-data; boundary=XyZ67 
Content-Length: &lt;content length&gt;
-- XyZ67 
Content-Disposition: form-data; name="rootfs.img.gz"; 
filename="rootfs.img.gz" 
Content-Type: application/octet-stream 

&lt;rootfs.img.gz file content&gt; 

-- XyZ67--
</pre><h2><a class="anchor" id="reboot"></a>
Reboot</h2>
<pre class="fragment">/reboot
</pre><p>The command has no arguments and causes the camera to reboot. Command reply is sent before the reboot starts. All camera parameters, except date and time are preserved between reboots, to reset parameters to factory defaults, the reset command must be used.</p>
<dl class="section note"><dt>Note</dt><dd>Timezone and dst arguments of the date command are preserved between reboots.</dd></dl>
<h2><a class="anchor" id="reset"></a>
Reset</h2>
<pre class="fragment">/reset
</pre><p>The command resets all camera parameters, except those listed below, to their factory default values. Parameters of following commands are not modified:</p>
<ul>
<li>device_info</li>
<li>date</li>
</ul>
<h2><a class="anchor" id="status"></a>
Status</h2>
<pre class="fragment">/status
</pre><p>The command returns the current status of the camera and the important event that happened, with their time and status codes</p>
<ul>
<li>100: internal server error</li>
<li>101: server initialization failed</li>
<li>102: server started</li>
<li>103: new status file created</li>
<li>104: network parameters</li>
<li>105: firmware flashed</li>
<li>106: camera rebooted</li>
<li>107: watchdog reboot</li>
</ul>
<p>Each time the status command is issued, all the messages accumulated in the status file are returned and the file is erased.</p>
<h2><a class="anchor" id="device_info"></a>
Device_info</h2>
<pre class="fragment">/device_info?action=set&amp;&lt;argument&gt;=&lt;value&gt;
/device_info?action=get
</pre><table class="doxtable">
<tr>
<th>Argument </th><th>Type </th><th>Default value </th><th>Description </th></tr>
<tr>
<td>firmware </td><td>string </td><td>firmware and build version </td><td>Firmware version </td></tr>
<tr>
<td>hostname </td><td>string </td><td>ipcam-mac_address </td><td>Network host name </td></tr>
<tr>
<td>mac_address </td><td>string </td><td>hhhhhhhh hhhh </td><td>Mac address as series of hex digits </td></tr>
<tr>
<td>ip_address </td><td>string </td><td>192.168.1.60 </td><td>IP address as 4 groups of 1-3 digits </td></tr>
<tr>
<td>serial_number </td><td>integer </td><td>1000 </td><td>Camera serial number </td></tr>
<tr>
<td>dhcp </td><td>bool </td><td>true </td><td>Enable or disable DHCP </td></tr>
<tr>
<td>subnet </td><td>string </td><td>255.255.255.0 </td><td>Subnet mask </td></tr>
<tr>
<td>gateway </td><td>string </td><td>192.168.1.1 </td><td>Gateway IP address </td></tr>
<tr>
<td>model </td><td>string </td><td>ipcam </td><td>Camera model </td></tr>
<tr>
<td>motion_dest </td><td>string </td><td>192.168.1.1:9000 </td><td>motion packet destination </td></tr>
<tr>
<td>user_data </td><td>string </td><td>empty string </td><td>arbitrary user data </td></tr>
<tr>
<td>temperature </td><td>string </td><td>N/A </td><td>camera temperatures </td></tr>
<tr>
<td>uptime </td><td>integer </td><td>N/A </td><td>time in seconds since server started </td></tr>
<tr>
<td>packet_gap </td><td>integer </td><td>0 </td><td>gap between RTP packets in microsecs </td></tr>
</table>
<p>These network related arguments are discussed in section 5. <em>motion_dest</em> parameter specifies destination address for the motion vectors and it should be in the format ip_addr:port, for example: </p>
<pre class="fragment">device_info?action=set&amp;motion_dest=192.168.6.80:5468
</pre><p>This command will send motion vectors for each other frame as UDP packets to the address 192.168.6.80, port 5468.</p>
<dl class="section note"><dt>Note</dt><dd>The server does not automatically update hostname after mac address change. Since <em>device_info</em> is not part of <em>reset</em> command, user has to manually update <em>hostname</em> after mac_address change if he wants to preserve ipcam-mac_address format.</dd></dl>
<p>The <em>user_data</em> argument can be used to hold arbitrary data user wants to associate with the camera. However, since this argument is passed on URI, usual limitations with respect to available character set apply.</p>
<p>On the cameras that support temperature read-out, the <code>device_info?action=get</code> will also report the temperature as a sequence of 5 colon-separated integers in the following format: </p>
<pre class="fragment">temperature=&lt;current&gt;:&lt;min&gt;:&lt;max&gt;:&lt;abs_min&gt;:&lt;abs_max&gt;
</pre><p>where <em>min</em> and <em>max</em> are minimum and maximum temperatures since last server start and <em>abs_min</em>, <em>abs_max</em> are minimum and maximum temperatures ever. The server samples temperature once per 10 seconds and reports it in degree Celsius.</p>
<p>The uptime argument reports the time since the server started in seconds. Both uptime and temperature arguments are read-only.</p>
<p>The packet_gap argument specifies a gap to add between successive RTP packets. This setting may help with packet loss when streaming over UDP. For example, an I-frame at default settings may take 20-25 RTP packets to transmit and if two cameras connected to the same switch send an I-frame at the same time, that may cause the switch to drop packets. The packet_gap forces to streamer to insert gaps between successive packets, which helps the switch with multiplexing packets from multiple cameras and reducing packet drops.</p>
<h3>Example</h3>
<pre class="fragment">GET /cgi-bin/device_info?action=get

HTTP Code:      200 OK 
Content-Type:   text/plain 
Body:
firmware=2.3.4
hostname=ipcam-01:23:45:67:89:AB
mac_address=01:23:45:67:89:AB
ip_address=192.168.1.60
serial_number=234567890
model=ipcam
dhcp=true
subnet=255.255.0.0
gateway=192.168.1.1
motion_dest=192.168.6.44:9654
user_data=something
uptime=12945
temperature=33.7:20.2:50.1:18.0:60.0
</pre><h2><a class="anchor" id="stream"></a>
Stream</h2>
<pre class="fragment">/stream?action=set&amp;id=&lt;id&gt;&amp;&lt;argument&gt;=&lt;value&gt;
/stream?action=get&amp;id=&lt;id&gt;
</pre><table class="doxtable">
<tr>
<th>Argument </th><th>Type </th><th>Valid values </th><th>Description </th></tr>
<tr>
<td>id </td><td>int </td><td>0, 1, 2, 3 </td><td>Stream ID </td></tr>
<tr>
<td>enable </td><td>bool </td><td>true, false </td><td>if a stream is enabled or not </td></tr>
<tr>
<td>encoder </td><td>string </td><td>h264, mjpeg, mpeg4 </td><td>type of an encoder </td></tr>
<tr>
<td>rate_control </td><td>string </td><td>cbr, vbr, cq </td><td>Rate control algorithm </td></tr>
<tr>
<td>fps </td><td>int </td><td>1 .. 30 </td><td>frame rate (frames per second) </td></tr>
<tr>
<td>width </td><td>int </td><td>176 .. 1920 (mult 16) </td><td>stream horizontal resolution </td></tr>
<tr>
<td>height </td><td>int </td><td>128 .. 1080 (mult 16) </td><td>stream vertical resolution </td></tr>
<tr>
<td>bitrate </td><td>int </td><td>100 .. 15000 </td><td>not valid for MJPEG </td></tr>
<tr>
<td>max_bitrate </td><td>int </td><td>100 .. 15000 </td><td>Maximum bitrate for VBR </td></tr>
<tr>
<td>quality </td><td>int </td><td>10 .. 90 </td><td>quality </td></tr>
<tr>
<td>gop </td><td>int </td><td>1 .. 30 </td><td>GOP size </td></tr>
<tr>
<td>profile </td><td>string </td><td>base, main, high </td><td>only for H264, encoder profile </td></tr>
<tr>
<td>osd </td><td>bool </td><td>true, false </td><td>enable or disable osd for the stream </td></tr>
</table>
<p>All arguments except id and action are optional and if not provided, corresponding parameters are unchanged.</p>
<dl class="section note"><dt>Note</dt><dd>Changing stream parameters while clients are attached may cause clients to malfunction.</dd></dl>
<p><em>Height</em> and <em>width</em> parameters must be multiple of 16. As special case, height values of 1080, 540 and 270 are also valid, even if they are not multiple of 16.</p>
<p>The <em>osd</em> argument enables or disables the OSD display for the stream. The OSD is a date string, displayed in bottom right corner in the following format: dd-MMM-yyyy hh:mm:ss, Where MMM is an abbreviated 3 character month, dd is two digit day, yyyy is four digit year, hh is two digit hour (in 24 hour format), mm is 2 digit minute and ss is 2 digit second.</p>
<p>Frame per second (<em>fps</em>) must not be bigger then sensor sampling rate (see <em>sensor_rate</em> in the <a class="el" href="index.html#image">Image</a> command). If <em>fps</em> for any stream is bigger then sensor_rate when the camera initializes, it will be silently reduced to <em>sensor_rate</em>. If the user attempts to change it during camera operation to a value that is larger then the actual sensor rate, the server will reply with an error.</p>
<dl class="section note"><dt>Note</dt><dd>Actual sensor rate may be different to what is present in the <code>image?action=get</code> command, since the actual rate is set when the camera boots and never changes afterwards.</dd></dl>
<p>The <em>rate_control</em> parameter specifies the rate control algorithm used. Different rate control mode use different other parameters according to the following table:</p>
<table class="doxtable">
<tr>
<th>Rate Control </th><th>Full Name </th><th>Used Parameters </th></tr>
<tr>
<td>CBR </td><td>Constant Bit Rate </td><td>bitrate </td></tr>
<tr>
<td>VBR </td><td>Variable Bit Rate </td><td>bitrate max_bitrate </td></tr>
<tr>
<td>CQ </td><td>Constant Quality </td><td>quality max_bitrate </td></tr>
</table>
<p>In the Constant Quality mode, the quality parameter directly control Quantization Parameters (QP), which in turn affects image quality and bit stream size (i.e. bitrate). However, if that bitrate would exceed max_bitrate, the encoder switches to CBR centered at max_bitrate. In the default Constant Bit Rate, encoder attempts to maintain specified bitrate, by varying QP until bitrate budget is met, usually within 10%. Note that even in CBR mode, abrupt scene or motion changes may lead to temporary bitrate spikes. In VBR mode, user specifies average and max bitrate and the encoder attempts to maintain average bitrate, but allows excursions up to max_bitrate.</p>
<p>The default values for each parameter are described in the following table</p>
<table class="doxtable">
<tr>
<th>Parameter </th><th>Stream 0 </th><th>Stream 1 </th><th>Stream 2 </th><th>Stream 3</th></tr>
<tr>
<td>enable </td><td>true </td><td>false </td><td>false </td><td>false </td></tr>
<tr>
<td>encoder </td><td>h264 </td><td>mjpeg </td><td>h264 </td><td>h264 </td></tr>
<tr>
<td>rate_control </td><td>cbr </td><td></td><td>cbr </td><td>cbr </td></tr>
<tr>
<td>fps </td><td>25 </td><td>15 </td><td>30 </td><td>15 </td></tr>
<tr>
<td>width </td><td>1920 </td><td>480 </td><td>352 </td><td>352 </td></tr>
<tr>
<td>height </td><td>1080 </td><td>270 </td><td>240 </td><td>240 </td></tr>
<tr>
<td>bitrate </td><td>5000 </td><td></td><td>500 </td><td>250 </td></tr>
<tr>
<td>quality </td><td></td><td>70 </td><td></td><td></td></tr>
<tr>
<td>gop </td><td>25 </td><td></td><td>30 </td><td>15 </td></tr>
<tr>
<td>profile </td><td>main </td><td></td><td>main </td><td>main </td></tr>
</table>
<h2><a class="anchor" id="image"></a>
Image</h2>
<pre class="fragment">/image?action=set&amp;&lt;argument&gt;=&lt;value&gt;
/image?action=get
</pre><table class="doxtable">
<tr>
<th>Argument </th><th>Type </th><th>Valid values </th><th>Default </th><th>Description </th></tr>
<tr>
<td>osd </td><td>bool </td><td>true, false </td><td>false </td><td>Date OSD </td></tr>
<tr>
<td>brightness </td><td>int </td><td>0 .. 100 </td><td>50 </td><td>image brightness </td></tr>
<tr>
<td>hue </td><td>int </td><td>0 .. 100 </td><td>50 </td><td>image hue </td></tr>
<tr>
<td>saturation </td><td>int </td><td>0 .. 100 </td><td>50 </td><td>image saturation </td></tr>
<tr>
<td>contrast </td><td>int </td><td>0 .. 100 </td><td>50 </td><td>image contrast </td></tr>
<tr>
<td>sharpness </td><td>int </td><td>0 .. 100 </td><td>50 </td><td>image sharpness </td></tr>
<tr>
<td>exposure </td><td>int </td><td>0 .. 100 </td><td>50 </td><td>image exposure </td></tr>
<tr>
<td>motion_rate </td><td>int </td><td>0 .. 100 </td><td>0 </td><td>motion rate </td></tr>
<tr>
<td>flip </td><td>string </td><td>none, horizontal, vertical, both </td><td>none </td><td>flips the image </td></tr>
<tr>
<td>cvbs </td><td>bool </td><td>true, false </td><td>false </td><td>enables CVBS output </td></tr>
<tr>
<td>sensor_rate </td><td>int </td><td>25, 50 </td><td>30 </td><td>sensor sampling rate </td></tr>
<tr>
<td>tdn </td><td>string </td><td>auto, hardware, day, night </td><td>auto </td><td>TrueDayNight setting </td></tr>
</table>
<p>Image arguments affect all the streams. For example, if image flipping is applied, it will be present in all streams.</p>
<dl class="section note"><dt>Note</dt><dd>Changing osd with image command is equivalent to changing it for all streams.</dd></dl>
<p>The <em>motion_rate</em> parameter controls how often motion values are sent. When it is 0, no motion values are sent. Value N means that motion values are sent each Nth frame. Motion vector destination is part of device_info command.</p>
<p>Unlike all other arguments, the <em>flip</em> argument is relative to the current flip state. For example, if flip is vertical and a command <code>image?flip=horizontal</code> is used, the result flip state will be both.</p>
<p><em>Sensor_rate</em> argument controls sensor sampling frequency. Changing that value does not cause any immediate changes, because sensor rate can only be changed when the camera initializes. Consequently, the camera must be rebooted after sensor rate was changed for that setting to have effect.</p>
<p><em>tdn</em> mode changes how the camera determines day or night conditions. In auto mode, the camera makes true day/night decisions (TDN), which affect IR filter by analyzing the incoming video frames. In hardware mode, the TDN logic is driven by hardware. The actual mechanism used is platform dependent. The final two choices are manual modes: day installs the IR cut filter and night removes it.</p>
<h2><a class="anchor" id="snapshot"></a>
Snapshot</h2>
<pre class="fragment">/snapshot?action=set&amp;&lt;argument&gt;=&lt;value&gt;
/snapshot?action=get
/snapshot?action=send
</pre><table class="doxtable">
<tr>
<th>Argument </th><th>Type </th><th>Valid values </th><th>Default </th><th>Description </th></tr>
<tr>
<td>decimation </td><td>int </td><td>1, 4, 16 </td><td>16 </td><td>snapshot decimation factor </td></tr>
</table>
<p>The command allows to set up and retrieve snapshot parameters and retrieve a snaphot. The snapshot resolution is always decimated from the input video size. For 1080P HD video:</p>
<ul>
<li>decimation 1: 1920x1080</li>
<li>decimation 4: 960x540</li>
<li>decimation 16: 480x270</li>
</ul>
<p>The set command sets up snapshot resolution and the send command sends out the snapshot in the reply to HTTP GET command. The snapshot is always encoded as a single MJPEG frame.</p>
<h2><a class="anchor" id="roi"></a>
Regions of Interest</h2>
<pre class="fragment">/roi?id=&lt;n&gt;&amp;action=get
/roi?id=&lt;n&gt;&amp;action=set&amp;rectangles=&lt;list_of_rectangles&gt;
/roi?id=&lt;n&gt;&amp;action=add&amp;rectangles=&lt;list_of_rectangles&gt;
/roi?id=&lt;n&gt;&amp;action=delete&amp;rectangles=&lt;list_of_rectangles&gt;
/roi?id=&lt;n&gt;&amp;action=clear
</pre><table class="doxtable">
<tr>
<th>Argument </th><th>Type </th><th>Valid values </th><th>Default </th><th>Description </th></tr>
<tr>
<td>id </td><td>int </td><td>0 </td><td>0 </td><td>id of the region of interest </td></tr>
<tr>
<td>rectangles </td><td>list rectangles </td><td>see below </td><td></td><td>list of rectangels </td></tr>
</table>
<p>The command edits region of interest. The <em>id</em> argument specifies the region. Currently only id=0 is supported and it allows to specify the privacy mask. The id argument is optional and defaults to 0.</p>
<p>Regions are lists of rectangles. A rectangle is specified by a list of four points in the following order: x0, y0, x1, y0. Each point may be either a floating point number or an integer number. Floating point values must be in the range 0.0 .. 1.0 where the point (0.0, 0.0) represents the upper left corner and the point (1.0,1.0) represents the lower right corner. Integer values must in the range 0 .. WIDTH -1 for the horizontal coordinates and 0 .. HEIGHT - 1 for vertical coordinates, where WDITH=1920 and HEIGHT=1080.</p>
<p>Action <em>get</em> sends back a reply with the list of rectangles, using integer values. Action <em>set</em> sets the list of rectangles for a region, using either integer or floating point values. Action <em>add</em> adds to the current list of rectangles, the rectangles specified in the <em>rectangles</em> argument. Action <em>delete</em> removes rectangles from a region of interest. For each rectangle in the <em>rectangles</em> argument, if any of the rectangles in the region intesects that rectangle, it is delete. Action <em>clear</em> removes all rectangles in the given region.</p>
<dl class="section note"><dt>Note</dt><dd>It is possible to specify points using the <em>rectangles</em> argument, by setting x1==x0 and y1==y0. Points and lines (when x1==x0 or y1==y0, but not both) are ignored for <em>set</em> and <em>add</em> commands, but are valid arguments for _delete_command.</dd></dl>
<h3>Example</h3>
<pre class="fragment">/roi?action=set&amp;rectangles=0.1,0.2,0.3,0.4
/roi?action=get
    id=0
    points=0.1,0.2,0.3,0.4
/roi?action=add&amp;rectangles=0.8,0.9,0.7,0.8
/roi?action=get
    id=0
    points=0.1,0.2,0.3,0.4,0.7,0.8,0.8,0.9
/roi?action=delete&amp;rectangles=0.15,0.25,0.15,0.25
/roi?action=get
    id=0
    points=0.7,0.8,0.8,0.9</pre> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue May 14 2013 19:19:14 for CGI Server by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
